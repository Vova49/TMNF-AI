"""Глобальная конфигурация проекта Trackmania RL.

Этот модуль централизует все настраиваемые гиперпараметры и рабочие настройки,
чтобы другие компоненты (окружение, расчёт награды, клиент TMInterface и т.п.)
могли импортировать их, а не дублировать значения в коде.

Числа можно свободно менять или в будущем загружать из ``.toml`` / ``.yaml`` —
главное сохранять имена публичных атрибутов, тогда остальной код продолжит
корректно работать.
"""
from __future__ import annotations

from dataclasses import dataclass


# ---------------------------------------------------------------------------
# Группы dataclass — объединяем связанные параметры для наглядности
# ---------------------------------------------------------------------------
@dataclass
class TMInterfaceCfg:
    """Настройки низкоуровневого подключения к TMInterface."""

    host: str = "127.0.0.1"  # TCP-хост, на котором слушает плагин AngelScript
    port: int = 54540  # TCP-порт, который открывает плагин
    server_name: str = "TMInterface0"  # для обратной совместимости
    connect_timeout: float = 5.0  # таймаут подключения (сек)
    game_speed: float = 1.0  # 1.0 — реальное время; >1 быстрее; <1 медленнее
    prevent_finish: bool = True  # вызывать iface.prevent_simulation_finish()


@dataclass
class EnvCfg:
    """Параметры окружения в стиле Gymnasium."""

    # Сколько *физических тиков* агрегируем в один RL-шаг
    ticks_per_step: int = 2
    # Максимум тиков физики за эпизод (защитное ограничение)
    episode_max_ticks: int = 10_000
    # Путь по умолчанию к сохранённой центральной линии (можно переопределить)
    centerline_path: str = "coords.txt"

    respawn_cooldown_ticks: int = 20  # длительность кулдауна после респавна (в тиках)


@dataclass
class RewardCfg:
    """Коэффициенты и параметры для формирования сигнала награды."""

    # Простой скоростной шейпинг (reward = scale * speed)
    forward_speed_scale: float = 1e-3

    # Штраф за низкую скорость / простой
    W_IDLE: float = 0.1
    IDLE_SPEED_THRESH: float = 10.0

    # Прогресс и чекпоинты
    W_PROGRESS: float = 1.3       # вес основного прогресса по центру трассы (с выравниванием)
    W_CP: float = 10.0            # бонус за взятие чекпоинта (разовый)
    W_CP_SHAP: float = 0.02       # shaping за приближение к следующему CP (Δdist_cp)

    # Штрафы
    W_WALL: float = 4.0           # штраф за контакт со стеной (каждый тик контакта)
    W_BACKWARD: float = 2.0       # штраф за явное движение назад по s (не респавн)
    W_FALL: float = 20.0          # крупный штраф за падение ниже минимальной высоты трассы (Y < death_y)

    # Параметры формы
    BACKWARD_THRESH: float = 0.25  # порог «движения назад» по s (м/шаг)
    ALIGN_GAMMA: float = 1.0       # степень в выравнивании по cos(угла)
    CURV_BETA: float = 0.0         # делитель прогресса в зависимости от кривизны


# ---------------------------------------------------------------------------
# Экземпляры *изменяемых* конфигов — значения можно править во время работы
# ---------------------------------------------------------------------------
tmiface = TMInterfaceCfg()
env = EnvCfg()
reward = RewardCfg()

# ---------------------------------------------------------------------------
# Удобные верхнеуровневые алиасы (только чтение!), чтобы писать короче, например:
#     from trackmania_rl import config as cfg
#     cfg.TICKS_PER_STEP
# Вместо длинных цепочек атрибутов.
# ---------------------------------------------------------------------------
TICKS_PER_STEP: int = env.ticks_per_step
EPISODE_MAX_TICKS: int = env.episode_max_ticks
FORWARD_SPEED_SCALE: float = reward.forward_speed_scale
SERVER_NAME: str = tmiface.server_name
